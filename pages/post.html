<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Post — JobPulse Kolkata</title>
  <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
  <div class="container">
    <!-- Article Title -->
    <h1 id="ptitle" style="text-align:center">Loading…</h1>
    <p style="text-align:center">
      <a id="src" class="badge" href="#" target="_blank" rel="noopener">Source ↗</a>
    </p>

    <!-- Main Article -->
    <div id="article" class="article-wrap">Fetching article…</div>

    <!-- Fallback (if full HTML not allowed) -->
    <div id="fallback" class="article-wrap" style="display:none">
      <h2>Article (Excerpt)</h2>
      <div id="excerpt"></div>
      <p style="text-align:center">
        <a id="readsource" class="source-btn" target="_blank" rel="noopener">Read full on source ↗</a>
      </p>
    </div>

    <!-- Bottom Ad -->
    <div id="bottomAd" class="ad-slot ad-spacer" data-variant="multiplex"
         style="max-width:820px;margin:14px auto;"></div>
  </div>

  <!-- theme boot -->
  <script>
    (function(){ 
      try {
        const pref = localStorage.getItem('jp-theme'); 
        if(pref){ document.documentElement.setAttribute('data-theme', pref); } 
        else { document.documentElement.setAttribute('data-theme','dark'); }
      }catch{} 
    })();
  </script>

  <!-- article loader -->
  <script>
    (function(){
      function getQuery(name){ const u=new URL(location.href); return u.searchParams.get(name) || ''; }
      const title = decodeURIComponent(getQuery('title')||'');
      const link  = decodeURIComponent(getQuery('link')||'');
      const desc  = decodeURIComponent(getQuery('desc')||'');

      const ptitle = document.getElementById('ptitle');
      const srcA   = document.getElementById('src');
      const article = document.getElementById('article');
      const fb = document.getElementById('fallback');
      const excerptEl = document.getElementById('excerpt');
      const readBtn = document.getElementById('readsource');

      ptitle.textContent = title || 'Post';
      if (link) srcA.href = link; else srcA.textContent = 'No source link';

      async function hydrateAds(scope=document){
        try{
          for(const ph of scope.querySelectorAll('.ad-slot')){
            const variant = ph.dataset.variant || 'inarticle';
            let file = '/components/ads-unit-inarticle.html';
            if(variant==='display') file='/components/ads-unit-display.html';
            if(variant==='multiplex') file='/components/ads-unit-multiplex.html';
            const unit = await fetch(file).then(r=>r.text());
            ph.outerHTML = unit;
          }
        }catch(e){}
      }

      function interleaveMediaAndAds(container, images){
        const paras = Array.from(container.querySelectorAll('p'));
        if(!paras.length) return;
        const existing = new Set(Array.from(container.querySelectorAll('img')).map(i=>i.src));
        const queue = (images||[]).filter(u=>u && !existing.has(u));
        let imgIdx = 0;
        const insertAfter = (node, el) => node.parentNode.insertBefore(el, node.nextSibling);
        paras.forEach((p, idx)=>{
          if(idx>0 && idx % 2 === 0){
            const ad = document.createElement('div');
            ad.className='ad-slot ad-spacer';
            ad.dataset.variant='inarticle';
            insertAfter(p, ad);
          }
          if(idx>0 && idx % 3 === 0 && imgIdx < queue.length){
            const fig = document.createElement('figure');
            const img = new Image();
            img.loading='lazy'; img.alt=title||'Article image'; img.src=queue[imgIdx++];
            fig.appendChild(img);
            insertAfter(p, fig);
          }
        });
      }

      function renderExcerptAsParagraphs(text, container){
        const chunks = String(text||'').split(/\\n\\s*\\n|(?<=\\.)\\s{2,}/g);
        container.innerHTML='';
        chunks.forEach(t=>{
          const s = t.trim(); if(!s) return;
          const p=document.createElement('p'); p.textContent=s; container.appendChild(p);
        });
      }

      async function render(){
        try{
          const r = await fetch('/.netlify/functions/read-post?link='+encodeURIComponent(link));
          const j = await r.json();

          if (j.allowed && j.html) {
            article.innerHTML = j.html;
            interleaveMediaAndAds(article, j.images || []);
            await hydrateAds(article);
          } else {
            article.style.display='none';
            fb.style.display='block';
            const body = (j.excerpt && j.excerpt.trim().length) ? j.excerpt : (desc || 'No content available.');
            renderExcerptAsParagraphs(body, excerptEl);
            interleaveMediaAndAds(fb, j.images || []);
            await hydrateAds(fb);
            readBtn.href = j.link || link || '#';
          }
          await hydrateAds(document);
        } catch (e) {
          article.innerHTML = '<p class="notice">Could not fetch the article.</p>';
          await hydrateAds(document);
        }
      }
      render();
    })();
  </script>

  <!-- cookie consent + main -->
  <script src="/assets/js/cookie-consent.js"></script>
  <script src="/assets/js/main.js"></script>
</body>
</html>
<!-- final post.html content with centered article, interleaved images, ads, bottom ad -->
