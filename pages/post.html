<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Post â€” JobPulse Kolkata</title>
  <script src="/assets/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/assets/css/style.css">
  <style>
    .article-wrap{
      background:var(--card);border:1px solid var(--border);border-radius:12px;
      padding:16px; max-width:820px; margin:0 auto; line-height:1.65;
    }
    .article-wrap img{max-width:100%;height:auto;border-radius:8px;margin:8px 0;border:1px solid var(--border)}
    .ad-spacer{margin:10px 0}
    .source-btn{display:inline-block;margin:10px 0;padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text);text-decoration:none}
  </style>
</head>
<body>
  <div class="container">
    <h1 id="ptitle" style="text-align:center">Loadingâ€¦</h1>
    <p style="text-align:center"><a id="src" class="badge" href="#" target="_blank" rel="noopener">Source â†—</a></p>

    <!-- Full article target -->
    <div id="article" class="article-wrap">Fetching articleâ€¦</div>

    <!-- Fallback (long excerpt) -->
    <div id="fallback" class="article-wrap" style="display:none">
      <h2>Article (Long Excerpt)</h2>
      <div id="excerpt"></div>
      <p style="text-align:center"><a id="readsource" class="source-btn" target="_blank" rel="noopener">Read full on source â†—</a></p>
    </div>

    <!-- ðŸ”» Bottom ad slot (new) -->
    <div id="bottomAd" class="ad-slot ad-spacer" data-variant="multiplex" style="max-width:820px;margin:14px auto;"></div>
  </div>

  <script type="module">
    import { getQuery } from '/assets/js/utils.js';

    const title = decodeURIComponent(getQuery('title')||'');
    const link  = decodeURIComponent(getQuery('link')||'');
    const desc  = decodeURIComponent(getQuery('desc')||'');

    const ptitle = document.getElementById('ptitle');
    const srcA   = document.getElementById('src');
    const article = document.getElementById('article');
    const fb = document.getElementById('fallback');
    const excerptEl = document.getElementById('excerpt');
    const readBtn = document.getElementById('readsource');

    ptitle.textContent = title || 'Post';
    if (link) srcA.href = link; else srcA.textContent = 'No source link';

    // hydrate any .ad-slot placeholders into full AdSense units (same logic as on home)
    async function hydrateAds(scope=document){
      try{
        for(const ph of scope.querySelectorAll('.ad-slot')){
          const variant = ph.dataset.variant || 'inarticle';
          let file = '/components/ads-unit-inarticle.html';
          if(variant==='display') file='/components/ads-unit-display.html';
          if(variant==='multiplex') file='/components/ads-unit-multiplex.html';
          const unit = await fetch(file).then(r=>r.text());
          ph.outerHTML = unit;
        }
      }catch(e){}
    }

    // Place images between paragraphs and ads every few paragraphs
    function interleaveMediaAndAds(container, images){
      const paras = Array.from(container.querySelectorAll('p'));
      if(!paras.length) return;

      // Track images already present to avoid duplicates
      const existing = new Set(Array.from(container.querySelectorAll('img')).map(i=>i.src));
      const queue = (images||[]).filter(u=>u && !existing.has(u));

      let imgIdx = 0;
      const insertAfter = (node, el) => node.parentNode.insertBefore(el, node.nextSibling);

      paras.forEach((p, idx)=>{
        // Every 2 paragraphs: insert an in-article ad
        if(idx>0 && idx % 2 === 0){
          const ad = document.createElement('div');
          ad.className='ad-slot ad-spacer';
          ad.dataset.variant='inarticle';
          insertAfter(p, ad);
        }
        // Every 3 paragraphs: insert a source image if available
        if(idx>0 && idx % 3 === 0 && imgIdx < queue.length){
          const fig = document.createElement('figure');
          const img = new Image();
          img.loading='lazy'; img.alt=title||'Article image'; img.src=queue[imgIdx++];
          fig.appendChild(img);
          insertAfter(p, fig);
        }
      });
    }

    function renderExcerptAsParagraphs(text, container){
      // Split long excerpt into paragraphs by double newlines or sentence breaks
      const chunks = String(text||'').split(/\n\s*\n|(?<=\.)\s{2,}/g);
      container.innerHTML='';
      chunks.forEach(t=>{
        const s = t.trim(); if(!s) return;
        const p=document.createElement('p'); p.textContent=s; container.appendChild(p);
      });
    }

    async function render(){
      try{
        const r = await fetch('/.netlify/functions/read-post?link='+encodeURIComponent(link));
        const j = await r.json();

        if (j.allowed && j.html) {
          // Full sanitized HTML (original). Centered by CSS.
          article.innerHTML = j.html;
          interleaveMediaAndAds(article, j.images || []);
          await hydrateAds(article); // in-article units
        } else {
          // Long excerpt mode + images + ads
          article.style.display='none';
          fb.style.display='block';
          const body = (j.excerpt && j.excerpt.trim().length) ? j.excerpt : (desc || 'No content available.');
          renderExcerptAsParagraphs(body, excerptEl);
          interleaveMediaAndAds(fb, j.images || []);
          await hydrateAds(fb);
          readBtn.href = j.link || link || '#';
        }

        // ðŸ”» Hydrate bottom ad too
        await hydrateAds(document);

      } catch (e) {
        article.innerHTML = '<p class="notice">Could not fetch the article.</p>';
        // still hydrate bottom ad
        await hydrateAds(document);
      }
    }
    render();
  </script>

  <script type="module" src="/assets/js/main.js"></script>
</body>
</html>
