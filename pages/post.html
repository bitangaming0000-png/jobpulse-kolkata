<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Post — JobPulse Kolkata</title>
  <script src="/assets/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/assets/css/style.css">
  <style>
    .hero-img{width:100%;border-radius:12px;border:1px solid var(--border);margin:8px 0 14px;display:none}
    .ai-block{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .ai-block h2{margin-top:14px}
    .img-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;margin-top:8px}
    .skeleton{border:1px solid var(--border);border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.08), rgba(255,255,255,0.03));background-size:200% 100%;animation:shimmer 1.2s infinite linear}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <h1 id="ptitle" class="skeleton" style="height:28px;width:60%"></h1>
    <p><a id="src" class="badge" href="#" target="_blank" rel="noopener">Source ↗</a></p>

    <img id="hero" class="hero-img" alt="AI banner" />

    <div id="content" class="ai-block">
      <div class="skeleton" style="height:16px;width:90%;margin:8px 0"></div>
      <div class="skeleton" style="height:16px;width:95%;margin:8px 0"></div>
      <div class="skeleton" style="height:16px;width:80%;margin:8px 0"></div>
      <p class="muted" id="status">Generating an easy-to-read article…</p>
    </div>

    <div id="moreimg" class="img-grid"></div>
  </div>

  <script type="module">
    import { getQuery, truncate, safeURL } from '/assets/js/utils.js';

    const title = decodeURIComponent(getQuery('title')||'');
    const link  = decodeURIComponent(getQuery('link')||'');
    const desc  = decodeURIComponent(getQuery('desc')||'');
    const date  = decodeURIComponent(getQuery('date')||'');

    const $title = document.getElementById('ptitle');
    const $src   = document.getElementById('src');
    const $hero  = document.getElementById('hero');
    const $content = document.getElementById('content');
    const $status  = document.getElementById('status');
    const $grid    = document.getElementById('moreimg');

    // Set initial heading & source link
    $title.classList.remove('skeleton');
    $title.textContent = title || 'Article';
    $src.href = safeURL(link);

    // Helper: render fallback content if AI fails
    function renderFallback() {
      $content.innerHTML = `
        <h2>Quick Summary</h2>
        <p>${desc ? truncate(desc, 600) : 'We could not auto-generate a long article for this post right now.'}</p>
        <p class="muted">Tip: open the Source link above for original details.</p>
      `;
    }

    // Try to get AI article & images
    async function renderAI() {
      try {
        const r = await fetch('/.netlify/functions/ai-post?link='+encodeURIComponent(link));
        const j = await r.json();

        if (!r.ok) throw new Error(j.error || 'AI article error');
        if (!j || !j.html) { renderFallback(); return; }

        // Inject article HTML
        $content.innerHTML = j.html;

        // Generate & show images (banner + 2 inline)
        if (Array.isArray(j.images) && j.images.length) {
          try {
            const first = await fetch('/.netlify/functions/ai-image?prompt='+encodeURIComponent(j.images[0]));
            const fjson = await first.json();
            if (fjson && fjson.dataUrl) {
              $hero.src = fjson.dataUrl;
              $hero.style.display = 'block';
            }
          } catch(_) {}

          for (const p of (j.images.slice(1,3))) {
            try {
              const rr = await fetch('/.netlify/functions/ai-image?prompt='+encodeURIComponent(p));
              const jj = await rr.json();
              if (jj && jj.dataUrl) {
                const img = new Image(); img.src = jj.dataUrl; img.alt = p;
                img.style.width='100%'; img.style.borderRadius='12px'; img.style.border='1px solid var(--border)';
                $grid.appendChild(img);
              }
            } catch(_) {}
          }
        }
      } catch (e) {
        console.error('AI error:', e);
        renderFallback();
      }
    }

    // If no link in query, just show fallback from desc
    if (!link) {
      renderFallback();
    } else {
      renderAI();
    }
  </script>

  <script type="module" src="/assets/js/main.js"></script>
</body>
</html>
