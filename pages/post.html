<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Post — JobPulse Kolkata</title>
  <script src="/assets/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/assets/css/style.css">
  <style>
    .hero-img{width:100%;border-radius:12px;border:1px solid var(--border);margin:8px 0 14px;display:none}
    .ai-block h2{margin-top:14px}
    .img-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <h1 id="ptitle">Loading…</h1>
    <p><a id="src" class="badge" href="#" target="_blank" rel="noopener">Source ↗</a></p>
    <img id="hero" class="hero-img" alt="AI banner" />
    <div id="content" class="ai-block card">Generating…</div>
    <div id="moreimg" class="img-grid"></div>
  </div>

  <script type="module">
    import { getQuery } from '/assets/js/utils.js';

    const title = decodeURIComponent(getQuery('title')||'');
    const link  = decodeURIComponent(getQuery('link')||'');
    const desc  = decodeURIComponent(getQuery('desc')||'');

    document.getElementById('ptitle').textContent = title || 'Post';
    if (link) document.getElementById('src').href = link; else document.getElementById('src').textContent = 'No source link';

    const content = document.getElementById('content');
    const hero = document.getElementById('hero');
    const grid = document.getElementById('moreimg');

    async function tryTextFallback(){
      const seed = `Title: ${title}\n\nSummary: ${desc}\n\nWrite a long, structured article for West Bengal job seekers.`;
      const r = await fetch('/.netlify/functions/ai-post?text='+encodeURIComponent(seed));
      const j = await r.json();
      return j;
    }

    function maybeDisableAI(flag){
      if (flag) try{ localStorage.setItem('jp-ai-disabled', flag); }catch{}
    }

    async function render(){
      try{
        let r = await fetch('/.netlify/functions/ai-post?link='+encodeURIComponent(link));
        let j = await r.json();

        if (j.ai_disabled) maybeDisableAI(j.ai_disabled);

        if (!j || !j.html || j.ai_disabled) {
          // try local text fallback if we haven’t yet
          const f = await tryTextFallback();
          if (f.ai_disabled) maybeDisableAI(f.ai_disabled);
          j = f;
        }

        content.innerHTML = j.html || '<p class="notice">No content.</p>';

        // Images only if AI not disabled
        const disabled = (localStorage.getItem('jp-ai-disabled')||'').length>0;
        if (!disabled && Array.isArray(j.images) && j.images.length){
          const first = await fetch('/.netlify/functions/ai-image?prompt='+encodeURIComponent(j.images[0]));
          const fj = await first.json();
          if (fj.ai_disabled) maybeDisableAI(fj.ai_disabled);
          if (fj.dataUrl){ hero.src = fj.dataUrl; hero.style.display='block'; }

          if (!fj.ai_disabled){
            for (const p of j.images.slice(1)){
              const rr = await fetch('/.netlify/functions/ai-image?prompt='+encodeURIComponent(p));
              const jj = await rr.json();
              if (jj.ai_disabled) { maybeDisableAI(jj.ai_disabled); break; }
              if (jj.dataUrl){
                const img = new Image(); img.src = jj.dataUrl; img.alt = p; img.className='hero-img';
                grid.appendChild(img);
              }
            }
          }
        }
      }catch(e){
        content.innerHTML = '<p class="notice">Could not generate article.</p><pre class="muted">'+(e.message||'')+'</pre>';
      }
    }
    render();
  </script>

  <script type="module" src="/assets/js/main.js"></script>
</body>
</html>
