<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title id="pgTitle">Job Details — JobPulse Kolkata</title>
  <meta name="description" content="Full job details, eligibility, dates and how to apply.">
  <script src="/assets/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/assets/css/style.css">
  <style>
    .post-wrap{max-width:900px;margin:0 auto}
    .hero{width:100%;height:220px;border-radius:14px;border:1px solid var(--border);overflow:hidden;background:#0e1628;margin:10px 0}
    .hero img{width:100%;height:100%;object-fit:cover;display:block}
    .post h1{font-size:26px;margin:8px 0 4px}
    .post .meta{color:var(--muted);font-size:14px;margin-bottom:10px}
    .post .content h2{margin-top:16px}
    .post .content p{line-height:1.6}
    .key{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin:8px 0}
    .key .card{min-width:auto}
    .cta{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
  </style>
</head>
<body>
  <div class="container post-wrap">
    <article class="post card">
      <div class="hero"><img id="hero" alt=""></div>
      <h1 id="title">Loading…</h1>
      <div class="meta"><span id="date">—</span> · <a id="source" href="#" target="_blank" rel="noopener">View source ↗</a></div>

      <div class="cta">
        <a id="applyBtn" class="badge" href="#" target="_blank" rel="noopener">Apply / Official Link ↗</a>
        <a class="badge" href="/" rel="noopener">← Back to Home</a>
      </div>

      <div class="key">
        <div class="card"><strong>Organization</strong><div id="org" class="w-small">—</div></div>
        <div class="card"><strong>Post / Role</strong><div id="role" class="w-small">—</div></div>
        <div class="card"><strong>Category</strong><div id="cat" class="w-small">Job Update</div></div>
        <div class="card"><strong>Location</strong><div id="loc" class="w-small">West Bengal</div></div>
      </div>

      <div class="content" id="content">
        <h2>Overview</h2>
        <p id="ov">We’re preparing a clean summary from the source. Key eligibility and dates are listed below. Always verify on the official site before applying.</p>

        <h2>Eligibility</h2>
        <p id="elig">Eligibility details will vary based on the department. Please review the official notification linked above.</p>

        <h2>Important Dates</h2>
        <ul id="dates">
          <li>Application start / end dates will be available on the official website.</li>
        </ul>

        <h2>How to Apply</h2>
        <ol id="howto">
          <li>Visit the official link using the “Apply / Official Link ↗” button.</li>
          <li>Read the notification thoroughly.</li>
          <li>Register / log in and complete the form.</li>
          <li>Upload documents and pay fee (if applicable).</li>
          <li>Submit and save acknowledgement.</li>
        </ol>
      </div>
    </article>
  </div>

  <script type="module">
    import { truncate, safeURL } from '/assets/js/utils.js';

    function getParam(k){ const u=new URL(location.href); return u.searchParams.get(k)||''; }
    const title = decodeURIComponent(getParam('title'));
    const link  = decodeURIComponent(getParam('link'));
    const desc  = decodeURIComponent(getParam('desc')||'');
    const date  = decodeURIComponent(getParam('date')||'');

    // Basic fill
    document.getElementById('title').textContent = title || 'Job Details';
    document.getElementById('pgTitle').textContent = (title? title + ' — ' : '') + 'JobPulse Kolkata';
    document.getElementById('source').href = safeURL(link);
    document.getElementById('applyBtn').href = safeURL(link);
    document.getElementById('date').textContent = date ? new Date(date).toLocaleString('en-IN',{dateStyle:'medium', timeStyle:'short'}) : 'Recently updated';
    document.getElementById('ov').textContent = desc ? truncate(desc.replace(/<[^>]+>/g,''), 500) : `Latest update: ${title}. Details below.`;

    // Extract small fields from title/desc
    const lower = (title+' '+desc).toLowerCase();
    const org = (title.match(/^(.*?)\s*[:-]/)||[])[1] || (lower.includes('wbpsc')?'WBPSC':'—');
    document.getElementById('org').textContent = org || '—';
    const role = (title.replace(org,'').replace(/[:-]\s*/,'').trim()) || '—';
    document.getElementById('role').textContent = role || '—';

    // Parse dates present in text
    const MONTHS = ['jan','feb','mar','apr','may','jun','jul','aug','sep','sept','oct','nov','dec'];
    function tryParseDates(s){
      const out = new Set();
      const dmy = s.match(/\b([0-3]?\d)[\/\-]([01]?\d)[\/\-](20\d{2})\b/g) || [];
      dmy.forEach(x=>out.add(x));
      const long = s.match(/\b([0-3]?\d)\s+[A-Za-z]{3,9}\.?,?\s+(20\d{2})\b/g) || [];
      long.forEach(x=>out.add(x));
      const alt = s.match(/\b[A-Za-z]{3,9}\.?\s+[0-3]?\d,\s*(20\d{2})\b/g) || [];
      alt.forEach(x=>out.add(x));
      return [...out].slice(0,6);
    }
    const list = tryParseDates(title+' '+desc);
    if(list.length){
      const ul = document.getElementById('dates'); ul.innerHTML='';
      list.forEach(x=> { const li=document.createElement('li'); li.textContent = x; ul.appendChild(li); });
    }

    // Hero image from serverless generator (no paid API)
    async function loadHero(){
      try{
        const r = await fetch('/.netlify/functions/ai-image?prompt='+encodeURIComponent('West Bengal job news: '+title));
        const j = await r.json();
        if(j && j.dataUrl){ document.getElementById('hero').src = j.dataUrl; document.getElementById('hero').alt = title; }
      }catch{}
    }
    loadHero();

    // Try to fetch expanded article from function; fallback to template
    async function tryExpanded(){
      try{
        const url = '/.netlify/functions/ai-post?link=' + encodeURIComponent(link);
        const r = await fetch(url);
        if(!r.ok) throw new Error('expand failed');
        const j = await r.json();
        const html = j && (j.html || j.content || '');
        if(html){
          const box = document.getElementById('content');
          box.innerHTML = html + box.innerHTML; // keep our sections below as extra
        }
      }catch{
        // keep the structured template; no crash
      }
    }
    tryExpanded();
  </script>

  <script type="module" src="/assets/js/main.js"></script>
</body>
</html>
